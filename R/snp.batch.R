#' @title SNP batch analysis in asreml.
#' 
#' @description 
#' \code{snp.batch} This function carries out batch analysis for SNP effects with trait in asreml package.
#'  
#' @usage snp.batch(data,SNP.N,traitN,FMod=NULL,maxit=NULL,SNP.detail=FALSE,SNP.figure=FALSE,SNP.signif=TRUE,alpha=0.05) 
#' 
#' @param data	 asreml dataset.
#' @param SNP.N	 A vector with sites of all SNPs.
#' @param traitN	 A vector with sites of all traits.
#' @param FMod	 Fixed mode, y~x(default).
#' @param maxit	 Maximum number of iterations, 20(default). 
#' @param SNP.detail	 Index to output information of every SNP type, F(default) for non-SNP-detail output.
#' @param SNP.figure	 Index to output boxplot of every SNP type, F(default) for non-figure output.
#' @param SNP.signif	 Index to output signif results of every SNP type, TRUE(default) for only significant output. 
#' @param alpha	 Signif levels of every SNP type, 0.05(default).
#' 
#' @export snp.batch
#' 
#' @author Yuanzhen Lin <yzhlinscau@@163.com>
#' @references
#' Yuanzhen Lin. R & ASReml-R Statistics. China Forestry Publishing House. 2016 
#' AAFMM website:https://github.com/yzhlinscau/AAFMM
#' @examples 
#' \dontrun{
#' library(AAFMM)
#' data(SNP)
#' df<-SNP #str(df)
#' 
#' library(asreml) # or library(asreml4)
#' 
#' snp.batch(df,SNP.N=2:4,traitN=c(5:6))
#' snp.batch(df,SNP.N=2:4,traitN=c(5:6), SNP.detail=TRUE)
#' snp.batch(df,SNP.N=2:4,traitN=c(5:6), SNP.figure=TRUE)
#' }
#' 

snp.batch <- function (data,SNP.N,traitN,FMod=NULL,maxit=NULL,
                       SNP.detail=FALSE,SNP.figure=FALSE,
                       SNP.signif=TRUE,alpha=0.05){
  options(digits=3)
  
  # require(ggplot2)
  
  ## theme for ggplot
  theme.1<-theme(
    axis.title=element_text(face="bold",colour="red",size=20),
    axis.text=element_text(face="bold",colour="black",size=10),
    axis.line=element_line(colour="black",size=1.5),
    panel.grid.major=element_line(colour="grey"),
    panel.grid.minor=element_line(colour="grey",size=.5), #linetype="dashed",
    panel.background=element_rect(fill="grey",colour="blue",size=1.5)    
  )
  
  if(is.null(FMod)) FMod<-y~x
  if(is.null(maxit)) maxit<-20
  
  aa<-SNP.N;cc<-traitN
  aaN<-length(aa);ccN<-length(cc)
  
  mm<-data.frame();tt<-SNP.infor<-list()
  NTrait<-N.Snp<-SNP.p<-vector() #=NULL
  
  for(i in 1:ccN){
    df1<-data[,c(aa,cc[i])]
    nn<-length(df1)
    
    NTrait[i]<-names(df1)[nn]
    for(j in 1:aaN){
      df2<-df1[,c(j,nn)]
      N.Snp[j]<-names(df2)[1]
      names(df2)[1:2]<-c("x","y")
      
      fm<-asreml(fixed=FMod, maxit=maxit, data=df2,trace=FALSE)
      
      SNP.p[j]<-round(wald(fm)[2,4],3)
      
      mm[j,1]<-N.Snp[j]
      mm[j,2]<-SNP.p[j]
      mm[j,3]<-sig.level2(mm[j,2])
      snpinfor<-summarise(group_by(df2, x), N=length(y), mean = mean(y), 
                         sd = sd(y), min=min(y),max=max(y))
      SNP.infor[[j]]<-list(SNP=N.Snp[j],SNP.infor=snpinfor)
      
      ggfigure<-ggplot(df2, aes(x=x, y=y)) + 
        labs(x = N.Snp[j], y = NTrait[i])+
        geom_boxplot(fill="forestgreen")+theme.1
      
      if(SNP.figure==TRUE) print(ggfigure)
    }
    names(mm)<-c("SNP","SNP.p","Sig.level")
    
    if(SNP.signif==TRUE) {
      mm<-subset(mm,SNP.p<=alpha)
    } else {mm<-mm}
    
    if(SNP.detail==FALSE) {tt[[i]]<-list(Trait=NTrait[i],SNP.p=mm)} else{
      tt[[i]]<-list(Trait=NTrait[i],SNP.p=mm,SNP.infor=SNP.infor)
    }
  }  
  print(tt)   
  cat("=================\n")
  cat("Sig.level: 0'***' 0.001 '**' 0.01 '*' 0.05 '.' 0.10 'Not signif' 1\n\n")
}